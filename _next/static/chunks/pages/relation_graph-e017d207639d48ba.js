(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[799],{18956:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/relation_graph",function(){return r(56760)}])},3585:function(e,t,r){"use strict";r.d(t,{D:function(){return f},r:function(){return d}});var n=r(85893),o=r(79351),l=r(47741),i=r(41664),a=r.n(i),s=r(95100),c=r(33256),u=r(40712);function d(e){let[t,r]=(0,s.v1)("modalId",s.U);return[null==e?void 0:e.find(e=>e.id===t),r]}function f(e){let{modalData:t,onClose:r}=e;return(0,n.jsxs)(o.u_,{isOpen:void 0!==t,onClose:r,size:"3xl",children:[(0,n.jsx)(o.ZA,{}),(0,n.jsxs)(o.hz,{children:[(0,n.jsxs)(o.xB,{children:["Catalog of ",t&&(0,c.ks)(t)," ",null==t?void 0:t.id," - ",null==t?void 0:t.name]}),(0,n.jsx)(o.ol,{}),(0,n.jsx)(o.fe,{children:t&&(0,n.jsx)(u.Rm,{src:t,collapsed:1,name:null,displayDataTypes:!1})}),(0,n.jsxs)(o.mz,{children:[t&&(0,c.vx)(t)&&(0,n.jsx)(l.zx,{colorScheme:"blue",mr:3,children:(0,n.jsx)(a(),{href:"/fragment_graph/?id=".concat(t.id),children:"View Fragments"})}),(0,n.jsx)(l.zx,{mr:3,onClick:r,children:"Close"})]})]})]})}},40712:function(e,t,r){"use strict";r.d(t,{Rm:function(){return w},KB:function(){return N},Kf:function(){return b},gU:function(){return y},vk:function(){return v},sW:function(){return k},v6:function(){return j}});var n=r(85893),o=r(47741),l=r(40639),i=r(36696),a=r(63679),s=r(9008),c=r.n(s),u=r(41664),d=r.n(u),f=r(67294),h=r(64030),m=r(44599),p=r(33256);function x(e){var t,r,n,o;return"columnDesc"in e?"".concat(null===(t=e.columnDesc)||void 0===t?void 0:t.name," (").concat(null===(n=e.columnDesc)||void 0===n?void 0:null===(r=n.columnType)||void 0===r?void 0:r.typeName,")"):"".concat(e.name," (").concat(null===(o=e.dataType)||void 0===o?void 0:o.typeName,")")}var g=r(3585);let w=(0,a.ZP)(()=>r.e(171).then(r.t.bind(r,55171,23))),v={name:"Depends",width:1,content:e=>(0,n.jsx)(d(),{href:"/relation_graph/?id=".concat(e.id),children:(0,n.jsx)(o.zx,{size:"sm","aria-label":"view dependents",colorScheme:"blue",variant:"link",children:"D"})})},j=[{name:"Primary Key",width:1,content:e=>e.pk.map(e=>e.columnIndex).map(t=>e.columns[t]).map(e=>x(e)).join(", ")},{name:"Vnode Count",width:1,content:e=>{var t;return null!==(t=e.maybeVnodeCount)&&void 0!==t?t:"?"}}],y={name:"Connector",width:3,content:e=>{var t;return null!==(t=e.withProperties.connector)&&void 0!==t?t:"unknown"}},b={name:"Connector",width:3,content:e=>{var t;return null!==(t=e.properties.connector)&&void 0!==t?t:"unknown"}},k=[v,{name:"Fragments",width:1,content:e=>(0,n.jsx)(d(),{href:"/fragment_graph/?id=".concat(e.id),children:(0,n.jsx)(o.zx,{size:"sm","aria-label":"view fragments",colorScheme:"blue",variant:"link",children:"F"})})}];function N(e,t,r){let{response:a}=(0,m.Z)(async()=>{let e=await t(),r=await (0,p.Rf)(),n=await (0,p.Cp)(),o=await (0,p.jW)();return e.map(e=>{let t=r.find(t=>t.id===e.owner),l=null==t?void 0:t.name,i=o.find(t=>t.id===e.schemaId),a=null==i?void 0:i.name,s=n.find(t=>t.id===e.databaseId),c=null==s?void 0:s.name;return{...e,ownerName:l,schemaName:a,databaseName:c}})}),[s,u]=(0,g.r)(a),d=(0,n.jsx)(g.D,{modalData:s,onClose:()=>u(null)}),w=(0,n.jsxs)(l.xu,{p:3,children:[(0,n.jsx)(h.Z,{children:e}),(0,n.jsx)(i.xJ,{children:(0,n.jsxs)(i.iA,{variant:"simple",size:"sm",maxWidth:"full",children:[(0,n.jsx)(i.hr,{children:(0,n.jsxs)(i.Tr,{children:[(0,n.jsx)(i.Th,{width:3,children:"Id"}),(0,n.jsx)(i.Th,{width:5,children:"Database"}),(0,n.jsx)(i.Th,{width:5,children:"Schema"}),(0,n.jsx)(i.Th,{width:5,children:"Name"}),(0,n.jsx)(i.Th,{width:3,children:"Owner"}),r.map(e=>(0,n.jsx)(i.Th,{width:e.width,children:e.name},e.name)),(0,n.jsx)(i.Th,{children:"Visible Columns"})]})}),(0,n.jsx)(i.p3,{children:null==a?void 0:a.map(e=>(0,n.jsxs)(i.Tr,{children:[(0,n.jsx)(i.Td,{children:(0,n.jsx)(o.zx,{size:"sm","aria-label":"view catalog",colorScheme:"blue",variant:"link",onClick:()=>u(e.id),children:e.id})}),(0,n.jsx)(i.Td,{children:e.databaseName}),(0,n.jsx)(i.Td,{children:e.schemaName}),(0,n.jsx)(i.Td,{children:e.name}),(0,n.jsx)(i.Td,{children:e.ownerName}),r.map(t=>(0,n.jsx)(i.Td,{children:t.content(e)},t.name)),e.columns&&e.columns.length>0&&(0,n.jsx)(i.Td,{overflowWrap:"normal",children:e.columns.filter(e=>!("isHidden"in e)||!e.isHidden).map(e=>x(e)).join(", ")})]},e.id))})]})})]});return(0,n.jsxs)(f.Fragment,{children:[(0,n.jsx)(c(),{children:(0,n.jsx)("title",{children:e})}),d,w]})}},63097:function(e,t,r){"use strict";r.d(t,{b:function(){return i},k:function(){return l}});var n=r(52189),o=r(98032);function l(e){let t=[n.rS.colors.green["100"],n.rS.colors.green["300"],n.rS.colors.yellow["400"],n.rS.colors.orange["500"],n.rS.colors.red["700"]].map(e=>(0,o.H)(e)),r=(e=Math.min(e=Math.max(e,0),100))/100*(t.length-1),l=Math.floor(r);return(0,o.H)(t[l]).mix((0,o.H)(t[Math.ceil(r)]),(r-l)*100).toHexString()}function i(e,t){return(e=Math.min(e=Math.max(e,0),100))/100*t+2}},13157:function(e,t,r){"use strict";r.d(t,{C8:function(){return s},Qc:function(){return l},Uz:function(){return a},_1:function(){return c}});var n=r(68905),o=r(35862);async function l(){return await o.ZP.get("/metrics/fragment/prometheus_back_pressures")}function i(e){let t=new Map,r=new Map,n=new Map;for(let n of e){let e="".concat(n.fragmentId,"-").concat(n.downstreamFragmentId);t.set(e,(t.get(e)||0)+n.value),r.set(e,(r.get(e)||0)+n.actorCount)}for(let[e,o]of t)n.set(e,o/r.get(e));return n}function a(e,t,r){let n=i(e),o=i(t),l=i(r),a=new Map;new Set([...n.keys(),...o.keys(),...l.keys()]).forEach(e=>{let t=n.get(e)||0,r=o.get(e)||0,i=l.get(e)||0;a.set(e,t+(i-r))});let s=[];return a.forEach((e,t)=>{let[r,n]=t.split("-").map(Number);s.push({actorCount:1,fragmentId:r,downstreamFragmentId:n,value:e})}),s}function s(e,t){let r=i(e),n=new Map;return r.forEach((e,r)=>{n.set(r,e/t*100)}),function(e){let t={outputBufferBlockingDuration:[]};for(let r of e)t.outputBufferBlockingDuration.push({metric:{actorId:r.actorId.toString(),fragmentId:r.fragmentId.toString(),downstreamFragmentId:r.downstreamFragmentId.toString()},sample:[{timestamp:Date.now(),value:r.backPressureRate}]});return t}(function(e){let t=[];return e.forEach((e,r)=>{let[n,o]=r.split("-").map(Number);t.push({actorId:0,fragmentId:n,downstreamFragmentId:o,backPressureRate:e})}),t}(n))}async function c(){var e,t;return null!==(t=null===(e=(await o.ZP.get("/metrics/fragment/embedded_back_pressures")).backPressureInfos)||void 0===e?void 0:e.map(n.hL.fromJSON))&&void 0!==t?t:[]}},53911:function(e,t,r){"use strict";r.d(t,{A8:function(){return l},AJ:function(){return a},Sx:function(){return i},jI:function(){return s}});var n=r(6162),o=r.n(n);function l(e,t,r){let n=function(e){let t=new Map;for(let r of e)t.set(r.id,r);let r=new Map,n=new Map,o=e=>{let l=n.get(e);if(void 0!==l)return l;let i={nextNodes:[]},a=t.get(e);if(void 0===a)throw Error("no such id ".concat(e));for(let e of a.parentIds)o(e).nextNodes.push(i);return n.set(e,i),r.set(i,e),i};for(let t of e)o(t.id);let l=new Map,i=[];for(let e of r.keys())i.push(e);for(let e of function(e){let t=[],r=[],n=new Map,o=e=>{if(e.temp)throw Error("This is not a DAG");if(!e.perm){e.temp=!0;let r=-1;for(let t of e.node.nextNodes){n.get(t).isInput=!1,e.isOutput=!1;let l=o(n.get(t));l>r&&(r=l)}e.temp=!1,e.perm=!0,e.g=r+1,t.unshift(e.node)}return e.g};for(let t of e){let e={node:t,temp:!1,perm:!1,isInput:!0,isOutput:!0,g:0};n.set(t,e),r.push(e)}let l=0;for(let e of r){let t=o(e);t>l&&(l=t)}for(let e of r)e.g=l-e.g;let i=[];for(let e=0;e<l+1;++e)i.push({nodes:[],occupyRow:new Set});let a=new Map,s=new Map;for(let e of r)i[e.g].nodes.push(e.node),a.set(e.node,e.g);let c=(e,t)=>{s.set(e,t),i[a.get(e)].occupyRow.add(t)},u=(e,t,r)=>{for(let n=e;n<=t;++n)i[n].occupyRow.add(r)},d=(e,t)=>i[e].occupyRow.has(t),f=(e,t,r)=>{if(r<0)return!1;for(let n=e;n<=t;++n)if(d(n,r))return!0;return!1};for(let t of e)t.nextNodes.sort((e,t)=>a.get(t)-a.get(e));for(let e of i)for(let t of e.nodes){if(!s.has(t)){for(let e of t.nextNodes){if(s.has(e))continue;let r=-1;for(;f(a.get(t),a.get(e),++r););c(t,r),c(e,r),u(a.get(t)+1,a.get(e)-1,r);break}if(!s.has(t)){let e=-1;for(;d(a.get(t),++e););c(t,e)}}for(let e of t.nextNodes){if(s.has(e))continue;let r=s.get(t);if(!f(a.get(t)+1,a.get(e),r)){c(e,r),u(a.get(t)+1,a.get(e)-1,r);continue}for(r=-1;f(a.get(t)+1,a.get(e),++r););c(e,r),u(a.get(t)+1,a.get(e)-1,r)}}let h=new Map;for(let t of e)h.set(t,[a.get(t),s.get(t)]);return h}(i)){let n=r.get(e[0]);if(!n)throw Error("no corresponding item of node ".concat(e[0]));let o=t.get(n);if(!o)throw Error("item id ".concat(n," is not present in idToBox"));l.set(o,e[1])}return l}(e),l=new Map,i=new Map,a=0,s=0;for(let e of n){let t=e[0],r=e[1][0],n=e[1][1],c=l.get(r)||0;t.width>c&&l.set(r,t.width);let u=i.get(n)||0;t.height>u&&i.set(n,t.height),a=o()([r,a])||0,s=o()([n,s])||0}let c=new Map,u=new Map,d=(e,t,r,n)=>{let o=r.get(e);if(o)return o;if(0===e)o=0;else{let l=n.get(e-1);if(!l)throw Error("".concat(e-1," has no result"));o=d(e-1,t,r,n)+l+t}return r.set(e,o),o};for(let e=0;e<=a;++e)d(e,t,c,l);for(let e=0;e<=s;++e)d(e,r,u,i);let f=[];for(let[e,[t,r]]of n){let n=c.get(t),o=u.get(r);if(void 0!==n&&void 0!==o)f.push({x:n,y:o,...e});else throw Error("x of layer ".concat(t,": ").concat(n,", y of row ").concat(r,": ").concat(o," "))}return f}function i(e,t,r,n){return l(e,r,t).map(e=>{let{x:t,y:r,...o}=e;return{x:t+n,y:r+n,...o}}).map(e=>{let{x:t,y:r,...n}=e;return{x:r,y:t,...n}})}function a(e){let t=[],r=new Map;for(let t of e)r.set(t.id,t);for(let n of e)for(let e of n.parentIds){let o=r.get(e);t.push({points:[{x:n.x,y:n.y},{x:o.x,y:o.y}],source:n.id,target:e})}return t}function s(e){let t=[],r=new Map;for(let t of e)r.set(t.id,t);for(let n of e){for(let e of n.parentIds){let o=r.get(e);t.push({points:[{x:n.x+n.width/2,y:n.y+n.height/2},{x:o.x+o.width/2,y:o.y+o.height/2}],source:n.id,target:e})}for(let e of n.externalParentIds)t.push({points:[{x:n.x,y:n.y+n.height/2},{x:n.x+100,y:n.y+n.height/2}],source:n.id,target:e})}return t}},56760:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return M}});var n=r(85893),o=r(40639),l=r(47741),i=r(83234),a=r(57026),s=r(96486),c=r.n(s),u=r(9008),d=r.n(u),f=r(95100),h=r(67294),m=r(52189),p=r(79855),x=r(33256),g=r(53911),w=r(3585),v=r(63097);function j(e){let{nodes:t,selectedId:r,setSelectedId:o,backPressures:l}=e,[i,a]=(0,w.r)(t.map(e=>e.relation)),s=(0,h.useRef)(null),{layoutMap:c,width:u,height:d,links:f}=(0,h.useCallback)(()=>{let e=(0,g.Sx)(t,50,50,12).map(e=>{let{x:t,y:r,...n}=e;return{x:t+50,y:r+50,...n}}),r=(0,g.AJ)(e),{width:n,height:o}=function(e,t){let r=0,n=0;for(let{x:t,y:o}of e)r=Math.max(r,t+12),n=Math.max(n,o+12);return{width:r,height:n}}(e,0);return{layoutMap:e,links:r,width:n+50+100,height:o+50+100}},[t])();return(0,h.useEffect)(()=>{let e=s.current,t=p.Ys(e),n=p.ak_,i=p.jvg().curve(n).x(e=>{let{x:t}=e;return t}).y(e=>{let{y:t}=e;return t}),u=t.select(".edges").selectAll(".edge").data(f),d=e=>e===r,h=e=>{e.attr("d",e=>{let{points:t}=e;return i(t)}).attr("fill","none").attr("stroke-width",e=>{if(l){let t=l.get("".concat(e.target,"_").concat(e.source));if(t)return(0,v.b)(t,15)}return 2}).attr("stroke",e=>{if(l){let t=l.get("".concat(e.target,"_").concat(e.source));if(t)return(0,v.k)(t)}return m.rS.colors.gray["300"]}).attr("opacity",e=>d(e.source)||d(e.target)?1:.5);let t=e.select("title");return t.empty()&&(t=e.append("title")),t.text(e=>{if(l){let t=l.get("".concat(e.target,"_").concat(e.source));if(t)return"".concat(t.toFixed(2),"%")}return""}),e};u.exit().remove(),u.enter().call(e=>e.append("path").attr("class","edge").call(h)),u.call(h);let g=e=>{e.attr("transform",e=>{let{x:t,y:r}=e;return"translate(".concat(t,",").concat(r,")")});let t=e.select("circle");t.empty()&&(t=e.append("circle")),t.attr("r",12).attr("fill",e=>{let{id:t,relation:r}=e,n=(0,x.vx)(r)?"500":"400";return d(t)?m.rS.colors.blue[n]:m.rS.colors.gray[n]});let r=e.select(".text");r.empty()&&(r=e.append("text").attr("class","text")),r.attr("fill","black").text(e=>{let{name:t}=e;return t}).attr("font-family","inherit").attr("text-anchor","middle").attr("dy",24).attr("font-size",12).attr("transform","rotate(-8)");let n=e.select(".type");n.empty()&&(n=e.append("text").attr("class","type"));let l=e=>{let t=(0,x.Mk)(e);return"SINK"===t?"K":t.charAt(0)};n.attr("fill","white").text(e=>{let{relation:t}=e;return"".concat(l(t))}).attr("font-family","inherit").attr("text-anchor","middle").attr("dy",6).attr("font-size",16).attr("font-weight","bold");let i=e.select("title");return i.empty()&&(i=e.append("title")),i.text(e=>{let{relation:t}=e;return"".concat(t.name," (").concat((0,x.ks)(t),")")}),e.style("cursor","pointer").on("click",(e,t)=>{let{relation:r,id:n}=t;o(n),a(r.id)}),e},w=t.select(".boxes").selectAll(".node").data(c);w.enter().call(e=>e.append("g").attr("class","node").call(g)),w.call(g),w.exit().remove()},[c,f,r,a,o,l]),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("svg",{ref:s,width:"".concat(u,"px"),height:"".concat(d,"px"),children:[(0,n.jsx)("g",{className:"edges"}),(0,n.jsx)("g",{className:"boxes"})]}),(0,n.jsx)(w.D,{modalData:i,onClose:()=>a(null)})]})}var y=r(64030),b=r(61642),k=r(44599),N=r(13157);let I="200px";function M(){let{response:e}=(0,k.Z)(x.H4),{response:t}=(0,k.Z)(x.rs),[r,u]=(0,f.v1)("id",f.U),{response:m}=(0,k.Z)(x.yp),[p,g]=(0,h.useState)(!1),w=()=>{g(e=>!e)},v=(0,b.Z)(),M=(0,h.useCallback)(()=>e&&t?function(e,t){let r=[],n=new Set(e.map(e=>e.id));for(let l of(0,s.reverse)((0,s.sortBy)(e,"id"))){var o;r.push({id:l.id.toString(),name:l.name,parentIds:(0,x.vx)(l)&&t.has(l.id)?null===(o=t.get(l.id))||void 0===o?void 0:o.filter(e=>n.has(e)).map(e=>e.toString()):[],order:l.id,width:24,height:24,relation:l})}return r}(e,t):void 0,[e,t])(),[S,_]=(0,h.useState)("Embedded"),{response:C}=(0,k.Z)(N.Qc,5e3,"Prometheus"===S),[D,E]=(0,h.useState)();(0,h.useEffect)(()=>{if(p&&(E(void 0),w()),"Embedded"===S){let e=setInterval(()=>{(0,N._1)().then(e=>{E(t=>t?{previous:t.current,current:e,totalBackpressureNs:(0,N.Uz)(t.totalBackpressureNs,t.current,e),totalDurationNs:t.totalDurationNs+5e9}:{previous:e,current:e,totalBackpressureNs:[],totalDurationNs:0})},e=>{console.error(e),v(e,"error")})},5e3);return()=>{clearInterval(e)}}},[S,v,p]);let T=(0,h.useMemo)(()=>{if(!m)return new Map;let e=m.inMap,t=m.outMap;if(C||D){let r=new Map;if("Embedded"===S&&D)for(let n of(0,N.C8)(D.totalBackpressureNs,D.totalDurationNs).outputBufferBlockingDuration){let o=Number(n.metric.fragmentId),l=Number(n.metric.downstreamFragmentId);if(t[o]&&e[l]){o=t[o],l=e[l];let i="".concat(o,"_").concat(l);r.set(i,n.sample[0].value)}}else if("Prometheus"===S&&C){for(let n of C.outputBufferBlockingDuration)if(n.sample.length>0){let o=100*c()(n.sample).maxBy(e=>e.timestamp).value,l=Number(n.metric.fragment_id),i=Number(n.metric.downstream_fragment_id);if(t[l]&&e[i]){l=t[l],i=e[i];let n="".concat(l,"_").concat(i);r.set(n,o)}}}return r}},[S,C,D,m]),P=(0,n.jsxs)(o.kC,{p:3,height:"calc(100vh - 20px)",flexDirection:"column",children:[(0,n.jsx)(y.Z,{children:"Relation Graph"}),(0,n.jsxs)(o.kC,{flexDirection:"row",height:"full",children:[(0,n.jsx)(o.kC,{width:I,height:"full",maxHeight:"full",mr:3,alignItems:"flex-start",flexDirection:"column",children:(0,n.jsx)(o.xu,{flex:1,overflowY:"scroll",children:(0,n.jsxs)(o.gC,{width:I,align:"start",spacing:1,children:[(0,n.jsx)(l.zx,{onClick:e=>w(),children:"Reset Back Pressures"}),(0,n.jsxs)(i.NI,{children:[(0,n.jsx)(i.lX,{fontWeight:"semibold",mb:3,children:"Back Pressure Data Source"}),(0,n.jsxs)(a.Ph,{value:S,onChange:e=>_(e.target.value),defaultValue:"Embedded",children:[(0,n.jsx)("option",{value:"Embedded",children:"Embedded (5 secs)"},"Embedded"),(0,n.jsx)("option",{value:"Prometheus",children:"Prometheus (1 min)"},"Prometheus")]})]}),(0,n.jsx)(o.xv,{fontWeight:"semibold",mb:3,children:"Relations"}),null==e?void 0:e.map(e=>{let t=r===e.id;return(0,n.jsx)(l.zx,{colorScheme:t?"blue":"gray",color:t?"blue.600":"gray.500",variant:t?"outline":"ghost",py:0,height:8,justifyContent:"flex-start",onClick:()=>u(e.id),children:e.name},e.id)})]})})}),(0,n.jsxs)(o.xu,{flex:1,height:"full",ml:3,overflowX:"scroll",overflowY:"scroll",children:[(0,n.jsx)(o.xv,{fontWeight:"semibold",children:"Relation Graph"}),M&&(0,n.jsx)(j,{nodes:M,selectedId:null==r?void 0:r.toString(),setSelectedId:e=>u(parseInt(e)),backPressures:T})]})]})]});return(0,n.jsxs)(h.Fragment,{children:[(0,n.jsx)(d(),{children:(0,n.jsx)("title",{children:"Relation Graph"})}),P]})}}},function(e){e.O(0,[662,876,679,184,278,591,561,721,371,905,888,774,179],function(){return e(e.s=18956)}),_N_E=e.O()}]);